var Y=Object.defineProperty;var G=(t,e,s)=>e in t?Y(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var l=(t,e,s)=>(G(t,typeof e!="symbol"?e+"":e,s),s);import{r as m,j as u,ag as Q,ah as V,a as X,E as B,bx as K,as as Z,J as ee,x as P,O as te,M as se,av as re,_ as oe,a9 as ae,ac as O,by as ne,ae as ie,af as ce,Y as le}from"./multikey.BhREcByE.js";import{a as x,k as he,n as M,o as z,p as N}from"./multikey.PuU20_-i.js";const ue=({loading:t})=>u(V,{open:t,className:"MuiBackdrop-root-loading",children:u(Q,{color:"inherit"})}),de=m.memo(ue),fe=(t,e)=>{},_=X.create({timeout:6e4});_.interceptors.request.use(t=>{const e=x.currNetwork();t.baseURL=`${e.rpc}/api/v2`,t.headers["Content-Type"]="application/json; charset=utf-8";const s=x.getCacheToken("token");if(t.headers.Authorization=`Bearer ${s}`,t.method==="post"&&t.paramsData){const o=t.paramsData;let n="";const r=`----WebKitFormBoundary${Math.random().toString().replace(".","")}`;for(const i in o)n+=`\r
--${r}\r
`,n+=`Content-Disposition:form-data; name="${i}"\r
\r
`,n+=`${o[i]}`;n+=`\r
--${r}--\r
`;const a=`multipart/form-data; boundary=${r}`;t.headers["Content-Type"]=a,t.data=n}return t},t=>Promise.reject(t));_.interceptors.response.use(t=>{const{code:e}=t.data;return(e===401||e===-402)&&(window.location.href="/login",x.removeCacheToken("token")),t.status===200?Promise.resolve(t.data):Promise.reject(t)},t=>{const{response:e}=t;if(e)return fe(e.status,e.data.message),Promise.reject(e.data)});const T={request:_,get(t,e){e={_t:Date.parse(String(new Date))/1e3,...e};const s={method:"get",url:t,params:e};return e&&(s.params=e),_(s)},post(t,e){return _({method:"post",url:t,paramsData:e})},put(t){const e={method:"post"};return t&&(e.data=t),_(e)}};class me{constructor(){l(this,"_value")}set(e){e?typeof e=="boolean"?this._value=e:this._value=/^\s*(true|1(.(0)+)?)\s*$/i.test(e||""):this._value=!1}get(){return this._value}}class ye{constructor(){l(this,"_value")}set(e){e?typeof e=="string"?this._value=new B.Int64BE(e):typeof e=="number"?this._value=new B.Int64BE(e):this._value=e:this._value=new B.Int64BE}get(){return this._value}}class pe{constructor(){l(this,"_value")}set(e){if(typeof e=="number")this._value=e||0;else if(typeof e=="string"){const s=parseFloat(e);this._value=s||0}else this._value=0}get(){return this._value}}class ge{constructor(){l(this,"_value","0")}set(e){const s=e?e.toString().replace(",","."):"0";this._value=s}get(){return this._value}}let _e=class{constructor(){l(this,"_value")}set(e){this._value=e?e.toString():""}get(){return this._value}};class xe{constructor(){l(this,"_value")}set(e){this._value=e}get(){return this._value?{Name:this._value.name,MimeType:this._value.type,Body:this._value.value}:null}}class we{constructor(){l(this,"_value")}set(e){e?Array.isArray(e)?this._value=e.map(s=>s.toString()):this._value=[e.toString()]:this._value=[]}get(){return this._value}}class ve{constructor(){l(this,"_value")}set(e){this._value=e}get(){return this._value}}const F={header:new Uint8Array([128]),network:1,fields:{bool:me,int:ye,float:pe,money:ge,string:_e,file:xe,array:we,bytes:ve}};class H{constructor(e){l(this,"_fields",{});l(this,"_context");l(this,"_expedite","");l(this,"_time",0);l(this,"_publicKey");l(this,"_keyID");this._context=e,this._expedite=e.Expedite||"",this._time=Math.floor(new Date().getTime()/1e3),Object.keys(e.fields).forEach(s=>{const o=e.fields[s],n=this._context.schema.fields[o.type],r=new n;r.set(o.value,e.digits),this._fields[s]=r})}sign(e){const s=x.getCache("hasher"),o=he.getKeyring(s),n=o.generatePublicKey(e);this._publicKey=M(n),this._keyID=new B.Int64BE(o.publicToID(n));const r=this.serialize(),a=o.hexHash(r),i=o.signContract(a,e),h=M(i);return{hash:a,data:z(this._context.schema.header,z(N(r),N(h)))}}serialize(){const e={},s=localStorage.getItem("lang");let o="en";s&&s==="zh-cn"&&(o="zh");const n=this._expedite.toString()||"",r=K.createCodec({binarraybuffer:!0,preset:!0});Object.keys(this._fields).forEach(h=>{e[h]=this._fields[h].get()});const a={Header:{ID:this._context.id,Time:this._time,EcosystemID:this._context.ecosystem||1,KeyID:this._keyID,NetworkID:this._context.networkId||1,PublicKey:this._publicKey},Params:e,Lang:o||"en"};return n&&(a.Expedite=n),K.encode(a,{codec:r})}}let b=9,D=null;const be={ecosystem:1,async tokensSend(t,e){t.ecosystem&&(this.ecosystem=t.ecosystem);const s=await T.get(`/contract/${t.contractName}`);try{s&&this.generateBinary(s,t,e)}catch(o){typeof e=="function"&&e(o,"error")}},async tokensSendOther(t,e){t.ecosystem&&(this.ecosystem=t.ecosystem);const s=await T.get(`/contract/${t.contractName}`);try{s&&this.generateBinaryOther(s,t,e)}catch(o){typeof e=="function"&&e(o,"error")}},currentAccount(){return x.getCache("current")},async generateBinaryOther(t,e,s){const{privateKey:o,networkId:n}=this.currentAccount(),r={},a={},{Expedite:i,digits:h,ecosystem:y}=e;t.fields.forEach(c=>{r[c.name]={type:c.type,value:e[c.name]}});const f={...new H({id:t.id,networkId:n,schema:F,ecosystem:y||1,fields:r,Expedite:i,digits:h}).sign(o),name:t.name,params:r},w=Array.prototype.map.call(new Uint8Array(f.data),c=>`00${c.toString(16)}`.slice(-2)).join("");a[f.hash]=w,this.sendTx(a,s)},async generateBinary(t,e,s){const{privateKey:o,networkId:n}=this.currentAccount(),r={},a={},{Expedite:i,digits:h,ecosystem:y}=e;t.fields.forEach(c=>{r[c.name]={type:c.type,value:e[c.name]}});const f={...new H({id:t.id,networkId:n,schema:F,ecosystem:y||1,fields:r,Expedite:i,digits:h}).sign(o),name:t.name,params:r},w=Array.prototype.map.call(new Uint8Array(f.data),c=>`00${c.toString(16)}`.slice(-2)).join("");a[f.hash]=w,this.sendTx(a,s)},async sendTx(t,e){try{await T.post("/sendTx",t)&&this.txstatus(t,e)}catch(s){typeof e=="function"&&e(s,"error")}},async txstatus(t,e){const o={hashes:Object.keys(t)},n={data:JSON.stringify(o)},r=await T.post("/txstatus",n);try{if(r){const a=Object.keys(r.results),i=r.results[a[0]],{results:h}=r,y=a.some(d=>h[d].blockid==="");if(b<=0)return clearTimeout(D),b=9,e(0,"loading");if(i.errmsg)return clearTimeout(D),b=9,e(i,"error");if(y)D=setTimeout(()=>{this.txstatus(t,e),b-=1},5e3);else{if(clearTimeout(D),b=9,i.blockid){const[d]=a;i.txHash=d}return e(i,"success")}}}catch(a){typeof e=="function"&&e(a,"error")}}},De=({isCheck:t,params:e,close:s,confirm:o})=>{const n=Z(),{t:r}=ee(),a=x.getCache("current"),[i,h]=m.useState("text"),[y,d]=m.useState(""),[S,f]=m.useState(!1),[w,c]=m.useState(r("login.pwEmpty")),[L,g]=m.useState(!1),[W,k]=m.useState("error"),[q,v]=m.useState(""),[U,E]=m.useState(!1),j=()=>{d(""),h(""),s()},$=m.useCallback(p=>p==""?(f(!0),c(r("login.pwEmpty")),!1):p!==a.password?(f(!0),c(r("login.incorrect")),!1):(f(!1),c(""),!0),[a,r]),J=p=>{const{value:C}=p.target;h("password"),d(p.target.value),$(C)},A=()=>{g(!1),d(""),f(!1),c(""),o()},R=()=>{try{$(y)&&(E(!0),be.tokensSend(e,(C,I)=>{I==="error"?(g(!0),k("error"),v(C.errmsg.error)):I==="loading"?(g(!0),k("warning"),v(r("user.chain"))):I==="success"?(g(!0),k("success"),v(r("user.dosuccess")),d(""),h("text")):(g(!0),k("error"),v(C.msg)),E(!1)}))}catch{g(!0),E(!1),v("Network failed")}};return P(le,{children:[u(ne,{open:t,onClose:j,"aria-labelledby":"modal-modal-title","aria-describedby":"modal-modal-description",children:P(te,{sx:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:{xs:"90%",md:"50%",lg:"30%",xl:"20%"},minWidth:460,maxWidth:600,bgcolor:n.palette.container.main,boxShadow:24,p:2,borderRadius:2},children:[u(se,{id:"modal-modal-title",variant:"h6",component:"h2",mb:3,children:r("home.check")}),u(re,{sx:{minWidth:120,width:"100%",mb:3},required:!0,children:u(oe,{required:!0,label:r("login.password"),onChange:J,size:"medium",autoComplete:"off",inputMode:"none",variant:"outlined",color:"secondary",type:i,value:y,error:S,fullWidth:!0,helperText:S?w:""})}),P(ae,{direction:"row",justifyContent:"space-around",alignItems:"center",children:[u(O,{variant:"outlined",onClick:j,size:"large",children:r("login.cancel")}),u(O,{variant:"filled",onClick:R,size:"large",children:r("login.confirm")})]})]})}),u(ce,{anchorOrigin:{vertical:"top",horizontal:"center"},open:L,onClose:A,autoHideDuration:2e3,children:u(ie,{onClose:A,severity:W,variant:"filled",sx:{width:"100%"},children:q})}),u(de,{loading:U})]})};export{De as P};
