var G=Object.defineProperty;var J=(t,e,s)=>e in t?G(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var c=(t,e,s)=>(J(t,typeof e!="symbol"?e+"":e,s),s);import{r as f,j as d,a4 as Q,aF as V,a as X,I as B,bt as K,U as Y,x as I,G as Z,a2 as ee,aI as te,ax as se,bu as re,ad as O,bv as oe,ae as ne,af as ae,a3 as ie}from"./multikey.Cv6HG7AM.js";import{a as w,k as ce,n as z,o as F,p as H}from"./multikey.EJ3kMsQf.js";const le=({loading:t})=>d(V,{open:t,className:"MuiBackdrop-root-loading",children:d(Q,{color:"inherit"})}),he=f.memo(le),ue=(t,e)=>{},x=X.create({timeout:6e4});x.interceptors.request.use(t=>{const e=w.currNetwork();t.baseURL=`${e.rpc}/api/v2`,t.headers["Content-Type"]="application/json; charset=utf-8";const s=w.getCacheToken("token");if(t.headers.Authorization=`Bearer ${s}`,t.method==="post"&&t.paramsData){const n=t.paramsData;let r="";const o=`----WebKitFormBoundary${Math.random().toString().replace(".","")}`;for(const i in n)r+=`\r
--${o}\r
`,r+=`Content-Disposition:form-data; name="${i}"\r
\r
`,r+=`${n[i]}`;r+=`\r
--${o}--\r
`;const a=`multipart/form-data; boundary=${o}`;t.headers["Content-Type"]=a,t.data=r}return t},t=>Promise.reject(t));x.interceptors.response.use(t=>{const{code:e}=t.data;return(e===401||e===-402)&&(window.location.href="/login",w.removeCacheToken("token")),t.status===200?Promise.resolve(t.data):Promise.reject(t)},t=>{const{response:e}=t;if(e)return ue(e.status,e.data.message),Promise.reject(e.data)});const D={request:x,get(t,e){e={_t:Date.parse(String(new Date))/1e3,...e};const s={method:"get",url:t,params:e};return e&&(s.params=e),x(s)},post(t,e){return x({method:"post",url:t,paramsData:e})},put(t){const e={method:"post"};return t&&(e.data=t),x(e)}};class de{constructor(){c(this,"_value")}set(e){e?typeof e=="boolean"?this._value=e:this._value=/^\s*(true|1(.(0)+)?)\s*$/i.test(e||""):this._value=!1}get(){return this._value}}class fe{constructor(){c(this,"_value")}set(e){e?typeof e=="string"?this._value=new B.Int64BE(e):typeof e=="number"?this._value=new B.Int64BE(e):this._value=e:this._value=new B.Int64BE}get(){return this._value}}class ye{constructor(){c(this,"_value")}set(e){if(typeof e=="number")this._value=e||0;else if(typeof e=="string"){const s=parseFloat(e);this._value=s||0}else this._value=0}get(){return this._value}}class me{constructor(){c(this,"_value","0")}set(e){const s=e?e.toString().replace(",","."):"0";this._value=s}get(){return this._value}}let pe=class{constructor(){c(this,"_value")}set(e){this._value=e?e.toString():""}get(){return this._value}};class ge{constructor(){c(this,"_value")}set(e){this._value=e}get(){return this._value?{Name:this._value.name,MimeType:this._value.type,Body:this._value.value}:null}}class _e{constructor(){c(this,"_value")}set(e){e?Array.isArray(e)?this._value=e.map(s=>s.toString()):this._value=[e.toString()]:this._value=[]}get(){return this._value}}class xe{constructor(){c(this,"_value")}set(e){this._value=e}get(){return this._value}}const M={header:new Uint8Array([128]),network:1,fields:{bool:de,int:fe,float:ye,money:me,string:pe,file:ge,array:_e,bytes:xe}};class N{constructor(e){c(this,"_fields",{});c(this,"_context");c(this,"_expedite","");c(this,"_time",0);c(this,"_publicKey");c(this,"_keyID");this._context=e,this._expedite=e.Expedite||"",this._time=Math.floor(new Date().getTime()/1e3),Object.keys(e.fields).forEach(s=>{const n=e.fields[s],r=this._context.schema.fields[n.type],o=new r;o.set(n.value,e.digits),this._fields[s]=o})}sign(e){const s=w.getCache("hasher"),n=ce.getKeyring(s),r=n.generatePublicKey(e);this._publicKey=z(r),this._keyID=new B.Int64BE(n.publicToID(r));const o=this.serialize(),a=n.hexHash(o),i=n.signContract(a,e),l=z(i);return{hash:a,data:F(this._context.schema.header,F(H(o),H(l)))}}serialize(){const e={},s=localStorage.getItem("lang");let n="en";s&&s==="zh-cn"&&(n="zh");const r=this._expedite.toString()||"",o=K.createCodec({binarraybuffer:!0,preset:!0});Object.keys(this._fields).forEach(l=>{e[l]=this._fields[l].get()});const a={Header:{ID:this._context.id,Time:this._time,EcosystemID:this._context.ecosystem||1,KeyID:this._keyID,NetworkID:this._context.networkId||1,PublicKey:this._publicKey},Params:e,Lang:n||"en"};return r&&(a.Expedite=r),K.encode(a,{codec:o})}}let b=9,T=null;const we={ecosystem:1,async tokensSend(t,e){t.ecosystem&&(this.ecosystem=t.ecosystem);const s=await D.get(`/contract/${t.contractName}`);try{s&&this.generateBinary(s,t,e)}catch(n){typeof e=="function"&&e(n,"error")}},async tokensSendOther(t,e){t.ecosystem&&(this.ecosystem=t.ecosystem);const s=await D.get(`/contract/${t.contractName}`);try{s&&this.generateBinaryOther(s,t,e)}catch(n){typeof e=="function"&&e(n,"error")}},currentAccount(){return w.getCache("current")},async generateBinaryOther(t,e,s){const{privateKey:n,networkId:r}=this.currentAccount(),o={},a={},{Expedite:i,digits:l,ecosystem:u}=e;t.fields.forEach(h=>{o[h.name]={type:h.type,value:e[h.name]}});const p={...new N({id:t.id,networkId:r,schema:M,ecosystem:u||1,fields:o,Expedite:i,digits:l}).sign(n),name:t.name,params:o},m=Array.prototype.map.call(new Uint8Array(p.data),h=>`00${h.toString(16)}`.slice(-2)).join("");a[p.hash]=m,this.sendTx(a,s)},async generateBinary(t,e,s){const{privateKey:n,networkId:r}=this.currentAccount(),o={},a={},{Expedite:i,digits:l,ecosystem:u}=e;t.fields.forEach(h=>{o[h.name]={type:h.type,value:e[h.name]}});const p={...new N({id:t.id,networkId:r,schema:M,ecosystem:u||1,fields:o,Expedite:i,digits:l}).sign(n),name:t.name,params:o},m=Array.prototype.map.call(new Uint8Array(p.data),h=>`00${h.toString(16)}`.slice(-2)).join("");a[p.hash]=m,this.sendTx(a,s)},async sendTx(t,e){try{await D.post("/sendTx",t)&&this.txstatus(t,e)}catch(s){typeof e=="function"&&e(s,"error")}},async txstatus(t,e){const n={hashes:Object.keys(t)},r={data:JSON.stringify(n)},o=await D.post("/txstatus",r);try{if(o){const a=Object.keys(o.results),i=o.results[a[0]],{results:l}=o,u=a.some(y=>l[y].blockid==="");if(b<=0)return clearTimeout(T),b=9,e(0,"loading");if(i.errmsg)return clearTimeout(T),b=9,e(i,"error");if(u)T=setTimeout(()=>{this.txstatus(t,e),b-=1},5e3);else{if(clearTimeout(T),b=9,i.blockid){const[y]=a;i.txHash=y}return e(i,"success")}}}catch(a){typeof e=="function"&&e(a,"error")}}},Ce=({isCheck:t,params:e,close:s,confirm:n})=>{const{t:r}=Y(),o=w.getCache("current"),[a,i]=f.useState("text"),[l,u]=f.useState(""),[y,g]=f.useState(!1),[p,m]=f.useState(r("login.pwEmpty")),[h,v]=f.useState(!1),[L,S]=f.useState("error"),[U,k]=f.useState(""),[W,P]=f.useState(!1),j=()=>{u(""),i(""),s()},A=f.useCallback(_=>_==""?(g(!0),m(r("login.pwEmpty")),!1):_!==o.password?(g(!0),m(r("login.incorrect")),!1):(g(!1),m(""),!0),[o,r]),q=_=>{const{value:C}=_.target;i("password"),u(_.target.value),A(C)},$=()=>{v(!1),u(""),g(!1),m(""),n()},R=()=>{A(l)&&(P(!0),we.tokensSend(e,(C,E)=>{E==="error"?(v(!0),S("error"),k(C.errmsg.error)):E==="loading"?(v(!0),S("warning"),k(r("user.chain"))):E==="success"?(v(!0),S("success"),k(r("user.dosuccess")),u(""),i("text")):(v(!0),S("error"),k(C.msg)),P(!1)}))};return I(ie,{children:[d(oe,{open:t,onClose:j,"aria-labelledby":"modal-modal-title","aria-describedby":"modal-modal-description",children:I(Z,{sx:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:{xs:"90%",md:"50%",lg:"30%",xl:"20%"},bgcolor:"background.paper",boxShadow:24,p:2,borderRadius:2},children:[d(ee,{id:"modal-modal-title",variant:"h6",component:"h2",mb:3,children:r("home.check")}),d(te,{sx:{minWidth:120,width:"100%",mb:3},required:!0,children:d(se,{required:!0,label:r("login.password"),onChange:q,size:"medium",autoComplete:"off",inputMode:"none",variant:"outlined",color:"secondary",type:a,value:l,error:y,fullWidth:!0,helperText:y?p:""})}),I(re,{children:[d(O,{variant:"outlined",sx:{minWidth:150,lineHeight:2.4},onClick:j,size:"large",children:r("login.cancel")}),d(O,{variant:"filled",sx:{minWidth:150,lineHeight:2.4},onClick:R,size:"large",children:r("login.confirm")})]})]})}),d(ae,{anchorOrigin:{vertical:"top",horizontal:"center"},open:h,onClose:$,autoHideDuration:2e3,children:d(ne,{onClose:$,severity:L,variant:"filled",sx:{width:"100%"},children:U})}),d(he,{loading:W})]})};export{Ce as P};
